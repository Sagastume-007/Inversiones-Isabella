<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 33%, #457b9d 66%, #90e0ef 100%);
      color: #2c3e50;
      margin: 0; 
      padding: 20px; 
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .panels {
      display: flex;
      gap: 20px;
      /* Reduce height importance so logo can grow */
      flex: 0 1 auto; 
      min-height: 300px; /* ensure they don't disappear */
    }
    .card {
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.85) 0%, rgba(255, 255, 255, 0.55) 55%, rgba(255, 255, 255, 0.28) 100%);
      color: #1a252f;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      padding: 15px;
      display: flex;
      flex-direction: column;
    }
    .calendar-card {
      flex: 1;
      max-width: 350px; /* Reduced width slightly */
    }
    .tasks-card {
      flex: 1;
    }
    
    /* Calendar Styles */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px; /* Reduced margin */
    }
    .calendar-header button {
      background: #e6f7ff;
      border: none;
      color: #1a252f;
      border-radius: 4px;
      padding: 3px 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .calendar-header h2 {
      margin: 0;
      font-size: 1.1rem;
      color: #1a252f;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 3px; /* Reduced gap */
      text-align: center;
    }
    .calendar-day-header {
      font-weight: bold;
      color: #e6f7ff;
      font-size: 0.8rem;
      padding-bottom: 3px;
    }
    .calendar-day {
      padding: 5px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.9rem;
      color: #1a252f;
    }
    .calendar-day:hover {
      background: #e6f7ff;
    }
    .calendar-day.selected {
      background: #fcbf49;
      color: #1a252f;
      font-weight: bold;
    }
    .calendar-day.today {
      border: 2px solid #74c69d;
    }
    .calendar-day.empty {
      cursor: default;
      background: transparent;
    }

    /* Task Styles */
    .task-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px; /* Reduced margin */
    }
    .task-input-group input {
      flex: 1;
      padding: 8px;
      border: 2px solid #a8dadc;
      background: #ffffff;
      color: #1a252f;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .task-input-group button {
      background: #e6f7ff;
      color: #1a252f;
      border: none;
      padding: 0 15px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      flex: 1;
      max-height: 250px; /* Limit height */
    }
    .task-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #c9d6e2;
      font-size: 1rem;
    }
    .task-item.completed span {
      text-decoration: line-through;
      color: #777;
    }
    .task-item span {
      flex: 1;
      margin-left: 10px;
      color: #1a252f;
      font-weight: bold;
      cursor: pointer;
    }
    .task-item.completed span {
        color: #777;
        font-weight: normal;
    }
    .task-delete {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      color: #ff6b6b;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .task-item:hover .task-delete {
      opacity: 1;
    }

    /* Logo Area */
    .logo-area {
      flex: 1; /* Allow to grow */
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      min-height: 200px;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.85) 0%, rgba(255, 255, 255, 0.55) 55%, rgba(255, 255, 255, 0.28) 100%);
      margin-top: 20px; /* Separation from panels */
    }
    .logo-area img {
      max-height: 45vh; /* Limit height relative to viewport */
      max-width: 100%;
      object-fit: contain;
      mix-blend-mode: multiply;
    }
    
    @media (max-width: 768px) {
      .panels {
        flex-direction: column;
      }
      .calendar-card {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="panels">
    <!-- Calendar Section -->
    <div class="card calendar-card">
      <div class="calendar-header">
        <button onclick="prevMonth()">&lt;</button>
        <h2 id="monthLabel"></h2>
        <button onclick="nextMonth()">&gt;</button>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- JS generated -->
      </div>
    </div>

    <!-- Tasks Section -->
    <div class="card tasks-card">
      <div class="task-input-group">
        <input type="text" id="taskInput" placeholder="Escribe una tarea..." onkeypress="handleEnter(event)">
        <button onclick="addTask()">‚ûï Agregar Tarea</button>
      </div>
      <ul class="task-list" id="taskList">
        <!-- JS generated -->
      </ul>
    </div>
  </div>

  <div class="logo-area">
    <img src="/static/img/logo.jpg" alt="Logo Sistema">
  </div>
</div>

<script>
  let currentDate = new Date();
  let selectedDate = new Date();

  function formatDate(d) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // --- Calendar Logic ---
  const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
  const dayNames = ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"];

  function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById("monthLabel").textContent = `${monthNames[month]} ${year}`;
    
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    // Headers
    dayNames.forEach(name => {
      const div = document.createElement("div");
      div.className = "calendar-day-header";
      div.textContent = name;
      grid.appendChild(div);
    });

    // Days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Empty slots
    for (let i = 0; i < firstDay; i++) {
      const div = document.createElement("div");
      div.className = "calendar-day empty";
      grid.appendChild(div);
    }

    // Days
    const today = new Date();
    for (let d = 1; d <= daysInMonth; d++) {
      const div = document.createElement("div");
      div.className = "calendar-day";
      div.textContent = d;
      
      const thisDate = new Date(year, month, d);
      
      if (thisDate.toDateString() === today.toDateString()) {
        div.classList.add("today");
      }
      if (thisDate.toDateString() === selectedDate.toDateString()) {
        div.classList.add("selected");
      }
      
      div.onclick = () => {
        selectedDate = new Date(year, month, d);
        renderCalendar();
        loadTasks();
      };
      
      grid.appendChild(div);
    }
  }

  function prevMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  }
  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  }

  // --- Tasks Logic ---
  async function loadTasks() {
    const dateStr = formatDate(selectedDate);
    const res = await fetch(`/api/tareas?fecha=${dateStr}`);
    const tasks = await res.json();
    
    const list = document.getElementById("taskList");
    list.innerHTML = "";
    
    tasks.forEach(t => {
      const li = document.createElement("li");
      li.className = `task-item ${t.completada ? 'completed' : ''}`;
      li.innerHTML = `
        <span onclick="toggleTask('${t.texto}')">‚Ä¢ ${t.texto}</span>
        <button class="task-delete" onclick="deleteTask('${t.texto}')">üóëÔ∏è</button>
      `;
      list.appendChild(li);
    });
  }

  async function addTask() {
    const input = document.getElementById("taskInput");
    const text = input.value.trim();
    if (!text) return;

    const dateStr = formatDate(selectedDate);
    await fetch("/api/tareas", {
      method: "POST",
      body: JSON.stringify({ fecha: dateStr, texto: text })
    });
    
    input.value = "";
    loadTasks();
  }

  async function toggleTask(text) {
    const dateStr = formatDate(selectedDate);
    await fetch("/api/tareas/toggle", {
      method: "POST",
      body: JSON.stringify({ fecha: dateStr, texto: text })
    });
    loadTasks();
  }

  async function deleteTask(text) {
    if(!confirm("¬øEliminar tarea?")) return;
    const dateStr = formatDate(selectedDate);
    await fetch("/api/tareas/delete", {
      method: "POST",
      body: JSON.stringify({ fecha: dateStr, texto: text })
    });
    loadTasks();
  }

  function handleEnter(e) {
    if (e.key === "Enter") addTask();
  }

  // Init
  renderCalendar();
  loadTasks();

</script>
</body>
</html>
